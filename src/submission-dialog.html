<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">

<dom-module id="sub-dialog">
	<template>
		<style include="shared-styles iron-flex iron-flex-alignment">
			:host {
				display : block;
				padding : 10px;
			}

			paper-button.cancel {
				background-color : var(--paper-red-400);
				color            : white;
			}

			paper-button.submit {
				background-color : var(--paper-green-400);
				color            : white;
			}

			paper-dialog {
				z-index : 1000;
			}

			paper-dropdown-menu, .subInput {
				@apply --layout-flex;
				margin : 0 8px;
			}

			paper-tabs {
				background-color                 : var(--google-blue-500);
				color                            : var(--google-grey-100);
				--paper-tabs-selection-bar-color : var(--paper-indigo-800);
				--paper-tabs-selection-bar       : var(--paper-blue-a700);
				--paper-tabs-selection-bar: {
					border : 2px solid var(--paper-indigo-800);
				}
			}

			.textAreas {
				margin           : 0;
				background-color : var(--paper-grey-50);
				color            : var(--google-grey-100);
			}

			@media ( min-width : 767px ) {
				paper-dialog {
					max-width : 30vw;
				}
			}

			@media ( max-width : 767px ) {
				:host {

				}

				.textAreas {
					@apply --layout-vertical;
				}

			}
		</style>

		<iron-ajax id="dbQueryIA"
				   auto
				   url="http://138.85.123.229/php/dbquery.php"
				   content-type="application/x-www-form-urlencoded"
				   method="POST"
				   body="[[params]]"
				   on-response="handleResponse"
				   last-response="{{response}}"
				   on-error="_confirmError">
		</iron-ajax>

		<paper-dialog id="submitDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" opened="{{opened}}" with-backdrop>
			<h2>Content Submission</h2>
			<p>Please fill out the entire form in order to complete your request.</p>
			<div id="submissionForm" class="layout container flex vertical">
				<paper-dropdown-menu id="submitFormApp"
									 label="Applications"
									 placeholder="Select An Application"
									 value="{{submissionSelections.application}}">
					<paper-listbox slot="dropdown-content" selected="{{submissionSelections.applicationIdx}}">
						<template is="dom-repeat" items="[[applications]]">
							<paper-item value="[[item]]">[[item]]</paper-item>
						</template>
					</paper-listbox>
				</paper-dropdown-menu>
				<div class="subInput">
					<paper-input label="Category" placeholder="Enter a category" required auto-validate></paper-input>
				</div>
				<div class="subInput">
					<paper-input label="Sub category" placeholder="Enter a sub category" required
								 auto-validate></paper-input>
				</div>
				<div class="subInput">
					<paper-input label="Issue" placeholder="What's the issue?" required auto-validate></paper-input>
				</div>
				<div class="subInput">
					<div class="textAreas">
						<paper-textarea id="subScript"
										label="Script"
										value="{{subScript}}"
										placeholder="Type or paste your script here">
						</paper-textarea>
					</div>
				</div>
				<div class="subInput">
					<div class="textAreas">
						<paper-textarea id="subWorkInstructions"
										label="Work Instructions"
										value="{{subWorkInstructions}}"
										placeholder="Type or paste related work instructions">
						</paper-textarea>
					</div>
				</div>
				<div class="layout horizontal end-justified">
					<paper-button class="cancel" raised>
						<iron-icon icon="clear"></iron-icon>
						Cancel
					</paper-button>
					<paper-button class="submit" raised>
						<iron-icon icon="check"></iron-icon>
						Submit
					</paper-button>
				</div>

			</div>
		</paper-dialog>
	</template>

	<script>
      class SubmissionDialog extends Polymer.Element {
        static get is () {
          return 'sub-dialog';
        }

        static get properties () {
          return {
            applications : Array,

            categories : Array,

            body : Object,

            docLink : String,

            issues : Array,

			opened : {
              type: Boolean,
			  value: false
			},

			params : {
              type  : Object,
              value : {
                tools : true
              }
            },

            response : Array,

            script : String,

            selections : {
              type   : Object,
              notify : true,
              value  : function () {
                return {};
              }
            },

            selected : {
              type  : Number,
              value : 0
            },

            selectedSubmission : {
              type  : Number,
              value : 0
            },

            subCategories : Array,

            submissionSelections : {
              type   : Object,
              notify : true,
              value  : function () {
                return {};
              }
            },

            workInstruction : String
          };
        }

        static get observers () {
          return [
            '_openDialog(opened)'
          ];
        }

        _scriptChanged () {
          if ( this.script ) {
            this.params.flag = true;
            this.$.dbQueryIA.generateRequest();
          }
        }

        _workInstChanged () {
          if ( this.workInstructions ) {
            this.params.doc = true;
            this.$.dbQueryIA.generateRequest();
          }
        }

        handleResponse ( res ) {
          if ( this.response ) {
            if ( !this.selections.application ) {
              this.applications = this.response.sort();
            }
            else if ( this.selections.application && !( this.selections.category || this.selections.subCategory || this.selections.issue ) ) {
              this.categories = this.response.sort();
            }
            else if ( this.selections.application && this.selections.category && !( this.selections.subCategory || this.selections.issue ) ) {
              this.subCategories = this.response.sort();
            }
            else if ( this.selections.application && this.selections.category && this.selections.subCategory && !this.selections.issue ) {
              this.issues = this.response.sort();
            }
            else if ( this.selections.application && this.selections.category && this.selections.subCategory && this.selections.issue && this.params.flag && this.params.doc ) {
              this.docLink = this.response[ 0 ];
              if ( this.docLink.length ) {
                this.$.download.classList.remove( 'disabled' );
              } else {
                this.$.download.classList.add( 'disabled' );
              }
            }
            else if ( this.selections.application && this.selections.category && this.selections.subCategory && this.selections.issue && this.params.flag ) {
              this.workInstructions = this.response[ 0 ];
            }
            else if ( this.selections.application && this.selections.category && this.selections.subCategory && this.selections.issue ) {
              this.script = this.response[ 0 ];
            }
          }
        }

        _confirmError ( err ) {
          this.$.applications.disabled = true;
          console.error( err );
        }

        _applicationChanged ( application ) {
          if ( application ) {
            delete this.params.tools;
            delete this.params.category;
            delete this.params.sub_category;
            delete this.params.issue;
            delete this.params.flag;

            this.selections.category = this.selections.categoryIdx = null;
            this.selections.subCategory = this.selections.subCategoryIdx = null;
            this.selections.issue = this.selections.issueIdx = null;
            this.docLink = null;

            this.notifyPath( 'selections.categoryIdx' );
            this.notifyPath( 'selections.subCategoryIdx' );
            this.notifyPath( 'selections.issueIdx' );

            this.$.categories._setSelectedItem( null );
            this.$.subCategories._setSelectedItem( null );
            this.$.issues._setSelectedItem( null );

            this.$.subCategories.disabled = true;
            this.$.issues.disabled        = true;

            this.$.download.classList.add( 'disabled' );

            this.params.table = this.params.tool = this.selections.application;
            this.$.dbQueryIA.generateRequest();
          }
        }

        _categoryChanged ( category ) {
          if ( category ) {
            delete this.params.sub_category;
            delete this.params.issue;
            delete this.params.flag;

            this.selections.subCategory = this.selections.subCategoryIdx = null;
            this.selections.issue = this.selections.issueIdx = null;
            this.docLink = null;

            this.notifyPath( 'selections.subCategoryIdx' );
            this.notifyPath( 'selections.issueIdx' );

            this.$.subCategories._setSelectedItem( null );
            this.$.issues._setSelectedItem( null );

            this.$.issues.disabled = true;
            this.$.download.classList.add( 'disabled' );
            this.params.category = this.selections.category;
            this.$.dbQueryIA.generateRequest();
          }
        }

        _subCategoryChanged ( subCategory ) {
          if ( subCategory ) {
            delete this.params.issue;
            delete this.params.flag;

            this.selections.issue = this.selections.issueIdx = null;
            this.docLink = null;

            this.notifyPath( 'selections.issueIdx' );

            this.$.issues._setSelectedItem( null );
            this.$.download.classList.add( 'disabled' );
            this.params.sub_category = this.selections.subCategory;
            this.$.dbQueryIA.generateRequest();
          }
        }

        _issueChanged ( issue ) {
          if ( issue ) {
            delete this.params.flag;
            this.params.issue = this.selections.issue;
            this.docLink      = null;
            this.$.download.classList.add( 'disabled' );
            this.$.dbQueryIA.generateRequest();
          }
        }

        _selectionChanged ( selection ) {
          let value;

          if ( selection === 'application' ) {
            value = this.selections.application ? selection.application : 'Select an application';
          }
          return value;
        }

        _openDialog () {
          if ( this.opened && !this.$.submitDialog.opened ) {
            this.$.submitDialog.open();
          }
        }

        ready () {
          super.ready();
          //this.addEventListener( 'iron-deselect', e => this._menuDeselect( e ) );
        }
      }

      window.customElements.define( SubmissionDialog.is, SubmissionDialog );
	</script>
</dom-module>
