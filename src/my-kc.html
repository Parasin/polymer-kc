<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="shared-styles.html">

<dom-module id="my-kc">
  <template>
        <style include="shared-styles">
            :host {
                display: block;
                padding: 10px;
            }

            ul {
                list-style: none;
                padding-left: 0;
            }
        </style>

        <iron-ajax id="dbQueryIA"
                   auto
                   url="http://138.85.231.86/php/dbquery.php"
                   content-type="application/x-www-form-urlencoded"
                   method="POST"
                   body="[[params]]"
                   on-response="handleResponse"
                   last-response="{{response}}"
                   on-error="_confirmError">
        </iron-ajax>

        <div class="card">
            <paper-dropdown-menu id="applications" label="Applications" placeholder="Select An Application" value="{{selections.application}}">
              <paper-listbox slot="dropdown-content">
                <template is="dom-repeat" items="[[applications]]">
                  <paper-item value="[[item]]">[[item]]</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>

            <paper-dropdown-menu disabled$="[[!selections.application]]" id="categories" label="Categories" placeholder="Select A Category" value="{{selections.category}}">
              <paper-listbox slot="dropdown-content">
                <template is="dom-repeat" items="[[categories]]">
                  <paper-item value="[[item]]">[[item]]</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>


        </div>
    </template>

  <script>
    class MyKc extends Polymer.Element {
      static get is() { return 'my-kc'; }
      static get properties() {
        return {
          params: {
            type  : Object,
    				value : {
              // table: 'EAMS',
              // category: 'Admin',
              // tool: 'EAMS',
              tools: true
              //sub_category: 'Access',
              // issue: 'Account Register'
    				}
          },
          body         : Object,
          response     : Array,
          applications : Array,
          categories   : Array,
          selections   : {
            type: Object,
            value: function() { return {}; }
          }
        };
      }

      static get observers() {
        return [
          '_applicationChanged(selections.application)'
        ];
      }

      handleResponse( res ) {
        if ( this.response ) {
          if ( !this.selections.application ) {
            this.applications = this.response.sort();
          }
          else if ( this.selections.application && !( this.selections.category && this.selections.subCategory && this.selections.issue) ) {
            this.categories = this.response.sort();
          }
        }
  		}

  		_confirmError( err ) {
  			console.error( err );
  		}

      _applicationChanged( application ) {
        if ( application ) {
          delete this.params.tools;
          this.params.table = this.params.tool = this.selections.application;
          this.$.dbQueryIA.generateRequest();
        }
      }

      _selectionChanged( selection ) {
        let value;

        if ( selection === 'application') {
          value = this.selections.application ? selection.application : 'Select an application';
        }
        console.log(value);
        return value;
      }
    }

    window.customElements.define(MyKc.is, MyKc);
  </script>
</dom-module>
